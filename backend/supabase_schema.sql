-- Script para crear tabla de ventas en Supabase
-- Ejecutar en SQL Editor de Supabase

CREATE TABLE IF NOT EXISTS ventas (
  id BIGSERIAL PRIMARY KEY,
  dia DATE NOT NULL,
  canal VARCHAR(100),
  sku VARCHAR(50),
  cantidad INTEGER DEFAULT 0,
  adquisicion VARCHAR(50),
  marca VARCHAR(50),
  modelo VARCHAR(200),
  origen VARCHAR(100),
  sucursal VARCHAR(200),
  ingreso_neto DECIMAL(12,2) DEFAULT 0,
  costo_neto DECIMAL(12,2) DEFAULT 0,
  margen DECIMAL(12,2) DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
);

-- Índices para mejorar performance
CREATE INDEX idx_ventas_dia ON ventas(dia);
CREATE INDEX idx_ventas_marca ON ventas(marca);
CREATE INDEX idx_ventas_canal ON ventas(canal);
CREATE INDEX idx_ventas_sucursal ON ventas(sucursal);

-- Habilitar RLS (Row Level Security) - Opcional
ALTER TABLE ventas ENABLE ROW LEVEL SECURITY;

-- Política para permitir lectura a todos (ajustar según necesidad)
CREATE POLICY "Enable read access for all users" ON ventas
  FOR SELECT
  USING (true);

-- Política para permitir insert a usuarios autenticados (ajustar según necesidad)
CREATE POLICY "Enable insert for authenticated users" ON ventas
  FOR INSERT
  WITH CHECK (true);

-- Insertar datos de ejemplo (formato chileno)
INSERT INTO ventas (dia, canal, sku, cantidad, adquisicion, marca, modelo, origen, sucursal, ingreso_neto, costo_neto, margen) VALUES
('2024-12-01', 'E-COMMERCE', '70012017', 1, 'ARRIENDO', 'HONOR', '90 LITE 256GB NGRE', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 185006.24, 160205.24, 24801.00),
('2024-12-01', 'E-COMMERCE', '70012259', 1, 'ARRIENDO', 'HONOR', 'X6A PLUS 256G PL', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 123314.64, 113402.00, 9912.64),
('2024-12-01', 'E-COMMERCE', '70012259', 1, 'ARRIENDO', 'HONOR', 'X6A PLUS 256G PL', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 123314.64, 113402.00, 9912.64),
('2024-12-01', 'E-COMMERCE', '70012259', 1, 'ARRIENDO', 'HONOR', 'X6A PLUS 256G PL', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 123314.64, 113402.00, 9912.64),
('2024-12-01', 'E-COMMERCE', '70012196', 1, 'ARRIENDO', 'MOTOROLA', 'ED40 256 X23031 EC', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 224763.05, 255475.00, -30711.95),
('2024-12-01', 'E-COMMERCE', '70011595', 1, 'ARRIENDO', 'SAMSUNG', 'GS23 256 S911DS BE', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 653862.37, 663085.00, -9222.63),
('2024-12-01', 'E-COMMERCE', '70012078', 1, 'ARRIENDO', 'MOTOROLA', 'MG54 256 GX2343 EE', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 141822.12, 127750.00, 14072.12),
('2024-12-01', 'E-COMMERCE', '70011172', 1, 'ARRIENDO', 'OPPO', 'A78 128GB GLOWING BLACK', 'CAMBIO', 'CAC_5332_CLARO CHILE_RENOVACION_XIII_LOBOZA 441', 191175.40, 132503.00, 58672.40),
('2024-12-02', 'CAC ANTOFAGASTA', '70011595', 11, 'VENTA', 'SAMSUNG', 'GS23 256 S911DS BE', 'NUEVO', 'CAC ANTOFAGASTA', 7192485.07, 7293935.00, -101449.93),
('2024-12-02', 'CAC ANTOFAGASTA', '70012259', 39, 'ARRIENDO', 'HONOR', 'X6A PLUS 256G PL', 'NUEVO', 'CAC ANTOFAGASTA', 4809270.96, 4422678.00, 386592.96),
('2024-12-02', 'CAC APOQUINDO', '70011595', 17, 'VENTA', 'SAMSUNG', 'GS23 256 S911DS BE', 'NUEVO', 'CAC APOQUINDO', 11106045.57, 11243895.00, -137849.43),
('2024-12-02', 'CAC ARICA II', '70012078', 22, 'ARRIENDO', 'MOTOROLA', 'MG54 256 GX2343 EE', 'NUEVO', 'CAC ARICA II', 3120086.64, 2810500.00, 309586.64),
('2024-12-03', 'CAC CALAMA', '70012017', 16, 'ARRIENDO', 'HONOR', '90 LITE 256GB NGRE', 'NUEVO', 'CAC CALAMA', 2960099.84, 2563283.84, 396816.00),
('2024-12-03', 'CAC CASTRO', '70011172', 43, 'VENTA', 'OPPO', 'A78 128GB GLOWING BLACK', 'NUEVO', 'CAC CASTRO', 8220541.20, 5697629.00, 2522912.20),
('2024-12-03', 'CAC CHILLÁN', '70012196', 26, 'ARRIENDO', 'MOTOROLA', 'ED40 256 X23031 EC', 'NUEVO', 'CAC CHILLÁN', 5843839.30, 6642350.00, -798510.70);

-- Confirmar que se insertaron los datos
SELECT COUNT(*) as total_registros FROM ventas;
SELECT marca, COUNT(*) as cantidad, SUM(margen) as margen_total 
FROM ventas 
GROUP BY marca 
ORDER BY cantidad DESC;
